<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Standards Link Viewer</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 1rem 1.2rem; line-height: 1.4; }
    h1 { margin: 0 0 0.5rem; }
    .muted { color: #555; margin-bottom: 1rem; }
    .controls { display: grid; grid-template-columns: repeat(4, minmax(170px, 1fr)); gap: 0.6rem; margin: 1rem 0; }
    label { font-size: 0.85rem; display: block; }
    select, input { width: 100%; padding: 0.4rem; margin-top: 0.2rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 0.7rem; font-size: 0.9rem; }
    th, td { border: 1px solid #ddd; padding: 0.45rem; vertical-align: top; }
    th { background: #f6f6f6; text-align: left; }
    .stats { margin-top: 0.5rem; font-size: 0.9rem; }
    .hint { margin-top: 0.8rem; font-size: 0.85rem; color: #444; }
  </style>
</head>
<body>
  <h1>Standards Link Viewer</h1>
  <div class="muted">Interactive filter for graph edges and part-level links.</div>

  <div class="controls">
    <div>
      <label for="dataset">Dataset</label>
      <select id="dataset">
        <option value="graph-edges">Graph edges</option>
        <option value="part-edges">Part-level edges</option>
      </select>
    </div>
    <div>
      <label for="nodeFilter">Node / Part</label>
      <input id="nodeFilter" placeholder="e.g., wcag-2.2" />
    </div>
    <div>
      <label for="relationFilter">Relation</label>
      <select id="relationFilter"><option value="">All relations</option></select>
    </div>
    <div>
      <label for="confidenceFilter">Confidence</label>
      <select id="confidenceFilter">
        <option value="">All</option>
        <option value="high">high</option>
        <option value="medium">medium</option>
      </select>
    </div>
  </div>

  <div class="stats" id="stats">Loadingâ€¦</div>
  <table id="table"></table>

  <div class="hint">
    Open via local server from repository root: <code>python -m http.server 8000</code><br />
    Then browse to: <code>http://localhost:8000/docs/standards-link-viewer.html</code>
  </div>

  <script>
    const DATA = {
      graphEdgesPath: '../kitty-specs/001-wai-standards-yaml-ld-ingestion/research/derived/standards-link-graph.edges.csv',
      partEdgesPath: '../kitty-specs/001-wai-standards-yaml-ld-ingestion/research/derived/standards-link-parts.edges.csv'
    };

    const refs = {
      dataset: document.getElementById('dataset'),
      nodeFilter: document.getElementById('nodeFilter'),
      relationFilter: document.getElementById('relationFilter'),
      confidenceFilter: document.getElementById('confidenceFilter'),
      stats: document.getElementById('stats'),
      table: document.getElementById('table')
    };

    let graphEdges = [];
    let partEdges = [];

    function parseCsv(text) {
      const lines = text.trim().split(/\r?\n/);
      if (!lines.length) return [];
      const headers = splitCsvLine(lines[0]);
      return lines.slice(1).filter(Boolean).map(line => {
        const cols = splitCsvLine(line);
        const row = {};
        headers.forEach((header, index) => { row[header] = cols[index] ?? ''; });
        return row;
      });
    }

    function splitCsvLine(line) {
      const out = [];
      let cur = '';
      let q = false;
      for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (ch === '"') {
          if (q && line[i + 1] === '"') { cur += '"'; i++; }
          else { q = !q; }
        } else if (ch === ',' && !q) {
          out.push(cur);
          cur = '';
        } else {
          cur += ch;
        }
      }
      out.push(cur);
      return out;
    }

    async function loadData() {
      const [graphText, partText] = await Promise.all([
        fetch(DATA.graphEdgesPath).then(r => r.text()),
        fetch(DATA.partEdgesPath).then(r => r.text())
      ]);
      graphEdges = parseCsv(graphText);
      partEdges = parseCsv(partText);
      repopulateRelationOptions();
      render();
    }

    function currentData() {
      return refs.dataset.value === 'graph-edges' ? graphEdges : partEdges;
    }

    function relationField() {
      return 'relation';
    }

    function sourceField() {
      return refs.dataset.value === 'graph-edges' ? 'from' : 'part_id';
    }

    function targetField() {
      return refs.dataset.value === 'graph-edges' ? 'to' : 'target';
    }

    function confidenceField() {
      return refs.dataset.value === 'graph-edges' ? 'confidence' : '';
    }

    function repopulateRelationOptions() {
      const relField = relationField();
      const values = [...new Set(currentData().map(row => row[relField]).filter(Boolean))].sort();
      refs.relationFilter.innerHTML = '<option value="">All relations</option>';
      for (const value of values) {
        const option = document.createElement('option');
        option.value = value;
        option.textContent = value;
        refs.relationFilter.appendChild(option);
      }
    }

    function render() {
      const rows = currentData();
      const src = sourceField();
      const tgt = targetField();
      const rel = relationField();
      const conf = confidenceField();

      const nodeNeedle = refs.nodeFilter.value.trim().toLowerCase();
      const relNeedle = refs.relationFilter.value;
      const confNeedle = refs.confidenceFilter.value;

      const filtered = rows.filter(row => {
        const nodeMatch = !nodeNeedle ||
          String(row[src] || '').toLowerCase().includes(nodeNeedle) ||
          String(row[tgt] || '').toLowerCase().includes(nodeNeedle);
        const relMatch = !relNeedle || row[rel] === relNeedle;
        const confMatch = !confNeedle || (conf && row[conf] === confNeedle);
        return nodeMatch && relMatch && confMatch;
      });

      refs.stats.textContent = `${filtered.length} / ${rows.length} rows shown`;

      const columns = refs.dataset.value === 'graph-edges'
        ? ['edge_id', 'from', 'relation', 'to', 'confidence', 'evidence']
        : ['part_id', 'relation', 'target', 'part_type'];

      refs.table.innerHTML = '';
      const thead = document.createElement('thead');
      const thr = document.createElement('tr');
      for (const col of columns) {
        const th = document.createElement('th');
        th.textContent = col;
        thr.appendChild(th);
      }
      thead.appendChild(thr);
      refs.table.appendChild(thead);

      const tbody = document.createElement('tbody');
      for (const row of filtered) {
        const tr = document.createElement('tr');
        for (const col of columns) {
          const td = document.createElement('td');
          td.textContent = row[col] || '';
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }
      refs.table.appendChild(tbody);
    }

    [refs.dataset, refs.nodeFilter, refs.relationFilter, refs.confidenceFilter].forEach(el => {
      el.addEventListener('input', () => {
        if (el === refs.dataset) {
          refs.nodeFilter.value = '';
          refs.relationFilter.value = '';
          refs.confidenceFilter.value = '';
          repopulateRelationOptions();
        }
        render();
      });
    });

    loadData().catch(err => {
      refs.stats.textContent = `Failed to load data: ${err.message}`;
    });
  </script>
</body>
</html>