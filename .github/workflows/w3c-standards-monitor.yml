name: W3C Standards Monitor

on:
  workflow_dispatch:
  schedule:
    - cron: "0 8 * * 1"

permissions:
  contents: read
  issues: write

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Check watched sources
        id: check
        run: |
          set +e
          python scripts/monitor_w3c_sources.py \
            --check \
            --watchlist monitoring/w3c-tr-watchlist.json \
            --report monitoring/w3c-change-report.md
          code=$?
          echo "exit_code=$code" >> "$GITHUB_OUTPUT"
          exit 0

      - name: Upload report artifact
        uses: actions/upload-artifact@v4
        with:
          name: w3c-change-report
          path: monitoring/w3c-change-report.md

      - name: Create issue when changes detected
        if: steps.check.outputs.exit_code != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('monitoring/w3c-change-report.md', 'utf8');
            const today = new Date().toISOString().slice(0, 10);
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `W3C standards source change detected (${today})`,
              body,
              labels: ['monitoring', 'standards']
            });
